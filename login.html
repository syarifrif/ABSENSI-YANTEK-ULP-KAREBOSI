<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Login • Absensi YANTEK ULP Karebosi</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="config.js"></script>
</head>
<body class="wrap">
  <header class="topbar">
    <div class="logo">
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/PLN_logo_2013.svg" alt="PLN"/>
      <div class="brand">Absensi <b>YANTEK ULP Karebosi</b></div>
    </div>
  </header>

  <div class="card" style="max-width:460px;margin:40px auto;">
    <h2 class="center" style="margin-top:0">Masuk</h2>
    <label>NIP</label>
    <input id="nip" placeholder="NIP"/>
    <label>PIN</label>
    <input id="pin" type="password" placeholder="PIN"/>
    <button id="btn" style="margin-top:12px">Login</button>
    <div id="status" class="msg"></div>
  </div>

  <footer class="muted center small">©2025 YANTEK ULP Karebosi</footer>

  <script>
  const $ = s => document.querySelector(s);

  function getJSONP(url){
    return new Promise((resolve,reject)=>{
      const cb = 'cb'+Date.now();
      window[cb] = d => { resolve(d); cleanup(); };
      const tag = document.createElement('script');
      function cleanup(){ delete window[cb]; tag.remove(); }
      tag.src = url + (url.includes('?')?'&':'?') + 'cb=' + cb;
      tag.onerror = ()=>{ cleanup(); reject(new Error('net')); };
      document.body.appendChild(tag);
    });
  }

  $('#btn').onclick = async ()=>{
    $('#status').className='msg'; $('#status').textContent='Memeriksa...';
    const nip = $('#nip').value.trim();
    const pin = $('#pin').value.trim();
    if(!nip||!pin){ $('#status').className='msg err'; $('#status').textContent='NIP & PIN wajib'; return; }

    try{
      const url = `${window.API_URL}?action=auth&nip=${encodeURIComponent(nip)}&pin=${encodeURIComponent(pin)}`;
      const r = await getJSONP(url);
      if(r.ok){
        localStorage.setItem('auth', JSON.stringify({ nip:r.nip, pin, nama:r.nama||'', role:r.role||'user' }));
        location.href='app.html';
      }else{
        $('#status').className='msg err'; $('#status').textContent = r.message || 'Gagal login';
      }
    }catch(e){
      $('#status').className='msg err'; $('#status').textContent='Tidak bisa menghubungi server';
    }
  };
  </script>
</body>
</html>
