<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Absensi YANTEK ULP Karebosi — Dashboard</title>
  <script src="config.js"></script>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --brand:#38bdf8; }
    body{margin:0;background:linear-gradient(160deg,#0b1220,#0f172a 45%,#0b1220);font-family:Inter,system-ui,Arial;color:var(--txt)}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{height:40px}
    .brand h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.3px}
    .userbox{font-size:13px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:rgba(17,24,39,.75);backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card h2{margin:0 0 10px 0;font-size:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    .btn{background:linear-gradient(180deg,#1d4ed8,#0ea5e9);border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#1f2937}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input,select{background:#0b1220;border:1px solid #334155;color:#e5e7eb;padding:9px 10px;border-radius:10px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:#a8b2c1;text-align:left;padding:0 10px}
    tbody td{background:#0b1220;border:1px solid #1f2a3a;padding:10px;border-left:none;border-right:none}
    tbody tr{border-radius:10px; overflow:hidden}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px}
    .ok{background:#065f46;color:#d1fae5}
    .warn{background:#7c2d12;color:#ffedd5}
    footer{margin-top:14px;font-size:12px;color:#9aa5b4}
    .hr{height:1px;background:#1f2937;margin:10px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <!-- Logo PLN (silakan ganti file/logo sendiri jika ada) -->
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/58/Logo_PLN.svg/320px-Logo_PLN.svg.png" alt="PLN"/>
      <h1>Absensi YANTEK ULP Karebosi</h1>
    </div>
    <div class="userbox">
      <div id="userName">—</div>
      <div><span id="todayStr">—</span> · <a href="login.html" style="color:#93c5fd">Keluar</a></div>
    </div>
  </div>

  <!-- Form Absen -->
  <div class="card">
    <h2>Form Absen</h2>
    <div class="row">
      <input id="nip" placeholder="NIP" />
      <input id="pin" placeholder="PIN (opsional)" />
      <select id="status">
        <option value="MASUK">MASUK</option>
        <option value="PULANG">PULANG</option>
        <option value="IZIN">IZIN</option>
        <option value="SAKIT">SAKIT</option>
        <option value="CUTI">CUTI</option>
        <option value="LEMBUR">LEMBUR</option>
      </select>
      <button class="btn" id="btnAbsen">Kirim Absen</button>
      <span id="msg" style="font-size:13px;color:#93c5fd"></span>
    </div>
  </div>

  <div class="grid">
    <!-- Rekap Harian -->
    <div class="card">
      <h2>Rekap Hari Ini</h2>
      <div class="row">
        <input type="date" id="dateDaily"/>
        <button class="btn secondary" id="btnReloadDaily">Muat</button>
        <button class="btn" id="btnExportDaily">Export CSV</button>
      </div>
      <div class="hr"></div>
      <table>
        <thead>
          <tr>
            <th>NIP</th><th>Nama</th><th>Status</th><th>Masuk</th><th>Pulang</th><th>Durasi</th><th>Lembur</th>
          </tr>
        </thead>
        <tbody id="tbodyDaily"><tr><td colspan="7">Belum ada data</td></tr></tbody>
      </table>
    </div>

    <!-- Rekap Bulanan -->
    <div class="card">
      <h2>Rekap Bulanan</h2>
      <div class="row">
        <input type="month" id="monthMonthly"/>
        <button class="btn secondary" id="btnReloadMonthly">Muat</button>
        <button class="btn" id="btnExportMonthly">Export CSV</button>
      </div>
      <div class="hr"></div>
      <table>
        <thead>
          <tr>
            <th>NIP</th><th>Nama</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Cuti</th><th>Hari Lembur</th><th>Total Jam</th><th>Total Lembur</th>
          </tr>
        </thead>
        <tbody id="tbodyMonthly"><tr><td colspan="9">Belum ada data</td></tr></tbody>
      </table>
    </div>
  </div>

  <footer>© <span id="year"></span> YANTEK ULP Karebosi · Data realtime dari Google Sheets.</footer>
</div>

<script>
  // ============ UTIL =============
  const TZ = 'Asia/Makassar';
  const fmtDate = (d)=> {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  };
  const fmtMonth = (d)=>{
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  };
  const toCSV = (rows, headers) => {
    const esc = (s)=> `"${String(s??'').replace(/"/g,'""')}"`;
    const head = headers.map(esc).join(',');
    const body = rows.map(r=> headers.map(h=>esc(r[h])).join(',')).join('\n');
    return head + '\n' + body;
  };
  const download = (filename, text) => {
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };

  // ============ STATE ============
  let profile = null; // {nip, nama, role} dari localStorage (di-set saat login)

  // ============ DOM ============
  const el = (id)=>document.getElementById(id);
  const tbodyDaily   = el('tbodyDaily');
  const tbodyMonthly = el('tbodyMonthly');

  // ============ API CALLS ============
  async function apiReportDaily(dateStr){
    const u = new URL(API_URL);
    u.searchParams.set('action','report');
    u.searchParams.set('type','daily');
    u.searchParams.set('date',dateStr);
    const r = await fetch(u.toString(), {method:'GET'});
    return r.json();
  }
  async function apiReportMonthly(monthStr){
    const u = new URL(API_URL);
    u.searchParams.set('action','report');
    u.searchParams.set('type','monthly');
    u.searchParams.set('month',monthStr);
    const r = await fetch(u.toString(), {method:'GET'});
    return r.json();
  }
  async function apiAbsen(payload){
    const r = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    return r.json();
  }

  // ============ RENDER =============
  function renderDaily(list){
    if (!list || list.length===0){
      tbodyDaily.innerHTML = `<tr><td colspan="7">Belum ada data</td></tr>`;
      return;
    }
    tbodyDaily.innerHTML = list.map(r=>{
      const badge = r.status==='HADIR' ? 'ok' :
                    (r.status==='IZIN'||r.status==='CUTI'||r.status==='SAKIT'||r.status==='LEMBUR' ? 'warn' : '');
      return `<tr>
        <td>${r.nip}</td>
        <td>${r.nama}</td>
        <td><span class="pill ${badge}">${r.status||''}</span></td>
        <td>${r.masuk||''}</td>
        <td>${r.pulang||''}</td>
        <td>${r.durasiJam||0}</td>
        <td>${r.lemburJam||0}</td>
      </tr>`;
    }).join('');
  }

  function renderMonthly(list){
    if (!list || list.length===0){
      tbodyMonthly.innerHTML = `<tr><td colspan="9">Belum ada data</td></tr>`;
      return;
    }
    tbodyMonthly.innerHTML = list.map(r=>`
      <tr>
        <td>${r.nip}</td>
        <td>${r.nama}</td>
        <td>${r.hadir||0}</td>
        <td>${r.izin||0}</td>
        <td>${r.sakit||0}</td>
        <td>${r.cuti||0}</td>
        <td>${r.lemburHari||0}</td>
        <td>${r.totalJam||0}</td>
        <td>${r.totalLembur||0}</td>
      </tr>
    `).join('');
  }

  // ============ LOADERS ============
  async function loadDaily(){
    const dateStr = el('dateDaily').value;
    const resp = await apiReportDaily(dateStr);
    if (resp.ok) renderDaily(resp.data); else alert(resp.message||'Gagal load harian');
  }
  async function loadMonthly(){
    const monthStr = el('monthMonthly').value;
    const resp = await apiReportMonthly(monthStr);
    if (resp.ok) renderMonthly(resp.data); else alert(resp.message||'Gagal load bulanan');
  }

  // ============ INIT ============
  (function init(){
    // tampilkan nama user (opsional)
    try {
      profile = JSON.parse(localStorage.getItem('absen_profile')||'null');
      if (profile) el('userName').textContent = `${profile.nama} (${profile.nip})`;
    } catch(e){}

    // tanggal default (Asia/Makassar)
    const now = new Date();
    el('todayStr').textContent = now.toLocaleString('id-ID',{timeZone:'Asia/Makassar'});
    el('dateDaily').value = fmtDate(now);
    el('monthMonthly').value = fmtMonth(now);
    el('year').textContent = now.getFullYear();

    // event
    el('btnReloadDaily').onclick = loadDaily;
    el('btnReloadMonthly').onclick = loadMonthly;

    el('btnExportDaily').onclick = async ()=>{
      const dateStr = el('dateDaily').value;
      const resp = await apiReportDaily(dateStr);
      if (!resp.ok) return alert(resp.message||'Gagal export');
      const headers = ['nip','nama','status','masuk','pulang','durasiJam','lemburJam'];
      const csv = toCSV(resp.data, headers);
      download(`rekap_harian_${dateStr}.csv`, csv);
    };
    el('btnExportMonthly').onclick = async ()=>{
      const monthStr = el('monthMonthly').value;
      const resp = await apiReportMonthly(monthStr);
      if (!resp.ok) return alert(resp.message||'Gagal export');
      const headers = ['nip','nama','hadir','izin','sakit','cuti','lemburHari','totalJam','totalLembur'];
      const csv = toCSV(resp.data, headers);
      download(`rekap_bulanan_${monthStr}.csv`, csv);
    };

    // submit absen
    el('btnAbsen').onclick = async ()=>{
      const nip = el('nip').value.trim();
      const pin = el('pin').value.trim();
      const status = el('status').value;
      if (!nip) return alert('NIP wajib');

      el('btnAbsen').disabled = true; el('msg').textContent = 'Mengirim...';
      try {
        const resp = await apiAbsen({nip, pin, status});
        el('msg').textContent = resp.message || (resp.ok?'Berhasil':'Gagal');
        if (resp.ok){
          // refresh rekap supaya terlihat langsung
          await loadDaily();
          await loadMonthly();
        }
      } catch(err){
        el('msg').textContent = 'Gagal kirim';
      } finally {
        el('btnAbsen').disabled = false;
        setTimeout(()=>{ el('msg').textContent=''; }, 3000);
      }
    };

    // load awal
    loadDaily();
    loadMonthly();
  })();
</script>
</body>
</html>
