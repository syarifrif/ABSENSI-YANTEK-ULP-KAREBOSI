<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absensi • YANTEK ULP Karebosi</title>
  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
</head>
<body class="wrap">
  <header class="topbar">
    <div class="brand">Absensi <b>YANTEK ULP Karebosi</b></div>
    <div class="user">
      <span id="hello"></span>
      <button id="logout" class="ghost">Keluar</button>
    </div>
  </header>

  <div class="card">
    <h2>Form Absen</h2>

    <div class="grid2">
      <div>
        <label>NIP</label>
        <input id="nip" disabled />
      </div>
      <div>
        <label>PIN</label>
        <input id="pin" type="password" />
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Status</label>
        <select id="status">
          <option>MASUK</option>
          <option>PULANG</option>
          <option>IZIN</option>
          <option>SAKIT</option>
          <option>CUTI</option>
          <option>LEMBUR</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="kirim">Kirim Absen</button>
      </div>
    </div>

    <div id="kirimStatus" class="msg"></div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="row">
        <h3>Rekap Hari Ini</h3>
        <div class="row gap">
          <input type="date" id="tgl">
          <button id="muatH">Muat</button>
          <button id="csvH" class="ghost">Export CSV</button>
        </div>
      </div>
      <div class="table">
        <table id="tblH">
          <thead><tr>
            <th>NIP</th><th>Nama</th><th>Status</th>
            <th>Masuk</th><th>Pulang</th><th>Durasi</th><th>Lembur</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <h3>Rekap Bulanan</h3>
        <div class="row gap">
          <input type="month" id="bulan">
          <button id="muatB">Muat</button>
          <button id="csvB" class="ghost">Export CSV</button>
        </div>
      </div>
      <div class="table">
        <table id="tblB">
          <thead><tr>
            <th>NIP</th><th>Nama</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Cuti</th>
            <th>Hari Lembur</th><th>Total Jam</th><th>Total Lembur</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer class="muted center small">©2025 YANTEK ULP Karebosi • Data realtime dari Google Sheets</footer>

  <script>
  const $ = s => document.querySelector(s);
  const auth = JSON.parse(localStorage.getItem('auth') || '{}');
  if (!auth.nip || !auth.pin){ location.href = 'login.html'; }

  // isi header
  $('#hello').textContent = auth.nama ? `${auth.nama} • ${auth.nip}` : auth.nip;
  $('#nip').value = auth.nip;
  $('#pin').value = auth.pin;

  $('#logout').onclick = ()=>{ localStorage.removeItem('auth'); location.href='login.html'; };

  // POST helper
  async function postJSON(url, obj){
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(obj)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // JSONP helper (untuk report agar aman CORS)
  function getJSONP(url){
    return new Promise((resolve, reject)=>{
      const cb = 'cb'+Date.now();
      window[cb] = d => { resolve(d); cleanup(); };
      const tag = document.createElement('script');
      function cleanup(){ delete window[cb]; tag.remove(); }
      tag.src = url + (url.includes('?')?'&':'?') + 'cb=' + cb;
      tag.onerror = ()=>{ cleanup(); reject(new Error('net')); };
      document.body.appendChild(tag);
    });
  }

 // Kirim Absen
$('#kirim').onclick = async ()=>{
  $('#kirimStatus').textContent = 'Mengirim...';
  try{
    let lat='', lng='';
    try {
      const p = await new Promise((ok,er)=>navigator.geolocation.getCurrentPosition(ok,er,{timeout:5000}));
      lat = p.coords.latitude; lng = p.coords.longitude;
    }catch(_){}

    // payload
    const payload = {
      nip: auth.nip,
      pin: $('#pin').value.trim(),
      status: $('#status').value,
      lat, lng
    };

    // kirim pakai form-urlencoded (lebih cocok untuk Apps Script doPost)
    const formData = new URLSearchParams();
    for (const k in payload) formData.append(k, payload[k]);

    const res = await fetch(window.API_URL, {
      method:'POST',
      body: formData
    });

    const j = await res.json();
    $('#kirimStatus').textContent = j.ok ? j.message : (j.message||'Gagal kirim');
    if (j.ok){ muatH(); muatB(); }

  }catch(e){
    console.error(e);
    $('#kirimStatus').textContent = 'Gagal kirim';
  }
};


  // Tabel harian
  function renderH(data){
    const tb = $('#tblH tbody'); tb.innerHTML='';
    if (!data || !data.length){
      tb.innerHTML = `<tr><td colspan="7" class="muted center">Belum ada data</td></tr>`;
      return;
    }
    for (const r of data){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.nip}</td><td>${r.nama}</td><td>${r.status||''}</td>
                      <td>${r.masuk||''}</td><td>${r.pulang||''}</td>
                      <td>${r.durasiJam||0}</td><td>${r.lemburJam||0}</td>`;
      tb.appendChild(tr);
    }
  }
  // Tabel bulanan
  function renderB(data){
    const tb = $('#tblB tbody'); tb.innerHTML='';
    if (!data || !data.length){
      tb.innerHTML = `<tr><td colspan="9" class="muted center">Belum ada data</td></tr>`;
      return;
    }
    for (const r of data){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.nip}</td><td>${r.nama}</td>
        <td>${r.hadir||0}</td><td>${r.izin||0}</td><td>${r.sakit||0}</td><td>${r.cuti||0}</td>
        <td>${r.lemburHari||0}</td><td>${r.totalJam||0}</td><td>${r.totalLembur||0}</td>`;
      tb.appendChild(tr);
    }
  }

  // Muat data harian & bulanan (JSONP)
  async function muatH(){
    const d = $('#tgl').value || new Date().toISOString().slice(0,10);
    const u = `${window.API_URL}?action=report&type=daily&date=${encodeURIComponent(d)}`;
    const j = await getJSONP(u);
    renderH(j.data||[]);
  }
  async function muatB(){
    const m = $('#bulan').value || new Date().toISOString().slice(0,7);
    const u = `${window.API_URL}?action=report&type=monthly&month=${encodeURIComponent(m)}`;
    const j = await getJSONP(u);
    renderB(j.data||[]);
  }

  // CSV export
  function tableToCSV(id){
    const rows = [...document.querySelectorAll(`#${id} tr`)];
    const csv = rows.map(r => [...r.children].map(td => {
      const t = td.textContent.replaceAll('"','""');
      return `"${t}"`;
    }).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (id==='tblH'?'rekap-harian':'rekap-bulanan') + '.csv';
    a.click();
  }
  $('#csvH').onclick = ()=>tableToCSV('tblH');
  $('#csvB').onclick = ()=>tableToCSV('tblB');

  // default tanggal/bulan & load
  $('#tgl').value = new Date().toISOString().slice(0,10);
  $('#bulan').value = new Date().toISOString().slice(0,7);
  $('#muatH').onclick = muatH;
  $('#muatB').onclick = muatB;

  muatH(); muatB();
  </script>
</body>
</html>

